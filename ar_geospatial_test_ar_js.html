<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='icon' type='image/png' sizes='32x32' href='favicon-32x32.png'>
    <link rel='icon' type='image/png' sizes='96x96' href='favicon-96x96.png'>
    <link rel='stylesheet' href='css/common.css'>
    <title>AR Geospatial Test AR JS</title>

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  </head>
  <body>
    <div id="scene_container"></div>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-analytics.js";
    import { getDatabase, set, ref, get, child } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.8.3/firebase-auth.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCfEFTVnA8S0xucNmUdNJHsy5u0ngjiahM",
        authDomain: "arcoregeospatial-352901.firebaseapp.com",
        databaseURL: "https://arcoregeospatial-352901-default-rtdb.firebaseio.com",
        projectId: "arcoregeospatial-352901",
        storageBucket: "arcoregeospatial-352901.appspot.com",
        messagingSenderId: "795811020862",
        appId: "1:795811020862:web:08e6e4039e32dbf479516f",
        measurementId: "G-CMTPZCXRXR"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
    const auth = getAuth();

    const dbRef = ref(database);

    signInAnonymously(auth).then((res) => {
        console.log("signed in successfully ... ");

        get(child(dbRef, 'Markers')).then((snapshot) => {
            if (snapshot.exists())
            {
                var scene = `
                    <a-scene
                    arjs="sourceType: webcam; debugUIEnabled: true;"
                    renderer="logarithmicDepthBuffer: true;"
                    embedded
                    loading-screen="enabled: true;">
                `;
                var entities = "";
                var assets = "<a-assets>";
                var camera = "<a-camera gps-camera rotation-reader> </a-camera>";

                var count = 1;
                snapshot.forEach(function(element) {
                    console.log(element.key);
                    console.log("Lat: " + element.val()["lat"]);
                    
                    assets = assets + `
                        <a-asset-item id="flower${count}" src="media/gltf/sunflower/sunflower.gltf"> </a-asset-item>
                    `;

                    entities = entities + `
                      <a-entity 
                        look-at="[gps-camera]" 
                        gltf-model="#flower${count}" 
                        scale="1.0 1.0 1.0" 
                        gps-entity-place="latitude: ${element.val()['lat']}; longitude: ${element.val()['lng']};">
                      </a-entity>
                    `;

                    count = count + 1;
                });

                assets = assets + "</a-assets>";

                scene = scene + camera + assets + entities + "</a-scene>";

                var sceneContainer = document.getElementById("scene_container");

                console.log(scene);

                sceneContainer.innerHTML = scene;
            }
            else 
            {
                console.log("No data available ... ");
            }
        }).catch ((err) => {
            console.log(err);
        });
    }).catch ((error) => {
        console.log(error);
    });
  </script>
  </body>
</html>